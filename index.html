<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SoundStudy for All Â· ë°ëª¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020817;
      --bg-card: #020617;
      --border-subtle: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.08);
      --accent-strong: #0ea5e9;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
      --radius-lg: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 1080px;
      margin: 0 auto;
      padding: 16px 14px 40px;
    }

    header.app-header {
      padding: 12px 16px 18px;
      border-radius: 24px;
      background: linear-gradient(135deg, #020617, #0b1220);
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .logo-circle {
      width: 34px;
      height: 34px;
      border-radius: 99px;
      background: radial-gradient(circle at 30% 20%, #e5f2ff, #38bdf8 45%, #020617 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: #0b1120;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.45),
        0 12px 30px rgba(15, 23, 42, 0.9);
    }

    h1 {
      font-size: 20px;
      margin: 0;
      letter-spacing: 0.02em;
    }

    .tagline {
      margin: 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .chip-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .chip.primary {
      border-color: rgba(56, 189, 248, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--accent);
    }

    /* NAV & MODE TOGGLE */

    .nav {
      display: flex;
      margin-top: 14px;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 2px;
    }

    .nav-btn {
      flex: 1 0 auto;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-muted);
      font-size: 13px;
      padding: 7px 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .nav-btn span.icon {
      font-size: 14px;
    }

    .nav-btn.active {
      border-color: rgba(56, 189, 248, 0.9);
      background: radial-gradient(circle at top, #0b1120, #020617);
      color: var(--accent);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .mode-toggle {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .mode-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .mode-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .mode-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      font-size: 11px;
      padding: 3px 9px;
      cursor: pointer;
      white-space: nowrap;
    }

    .mode-btn.small {
      font-size: 10px;
      padding: 2px 7px;
    }

    .mode-btn.active {
      border-color: rgba(56, 189, 248, 0.9);
      background: radial-gradient(circle at top, #0b1120, #020617);
      color: var(--accent);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    main {
      margin-top: 18px;
      display: grid;
      gap: 16px;
    }

    section.panel {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #020617, #020617 55%, #020617 100%);
      border: 1px solid rgba(31, 41, 55, 0.85);
      padding: 14px 14px 18px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.85);
    }

    section.panel h2 {
      font-size: 16px;
      margin: 0 0 4px;
    }

    .panel-subtitle {
      font-size: 12px;
      margin: 0 0 10px;
      color: var(--text-muted);
    }

    /* DASHBOARD */

    .grid { display: grid; gap: 10px; }
    @media (min-width: 720px) {
      .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .card {
      border-radius: 14px;
      background: linear-gradient(145deg, #020617, #020617);
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 10px 11px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .card-title { font-weight: 500; }

    .badge-soft {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--text-muted);
    }

    .level-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .level-display strong {
      color: var(--accent-strong);
      font-size: 15px;
    }

    .xp-bar-wrapper {
      margin-top: 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.95);
      height: 8px;
      overflow: hidden;
      position: relative;
    }

    .xp-bar-fill {
      position: absolute;
      inset: 0;
      width: 12%;
      border-radius: 999px;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.7);
      transition: width 0.35s ease-out;
    }

    .stat-main {
      font-size: 19px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .stat-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 4px;
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.8);
    }

    .pill.good {
      border-color: rgba(74, 222, 128, 0.6);
      color: var(--success);
    }

    /* FORM ELEMENTS */

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
      color: var(--text-muted);
    }

    input[type="text"],
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.95);
      padding: 7px 9px;
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }

    input[type="text"]::placeholder,
    textarea::placeholder { color: rgba(148, 163, 184, 0.6); }

    input[type="text"]:focus,
    textarea:focus {
      border-color: rgba(56, 189, 248, 0.85);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.8);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 7px;
    }

    button { font-family: inherit; }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 13px;
      padding: 7px 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }

    .btn.primary {
      border-color: rgba(56, 189, 248, 0.9);
      background: radial-gradient(circle at top, #0ea5e9, #0369a1);
      color: #e5f4ff;
      box-shadow: 0 10px 28px rgba(8, 47, 73, 0.85);
    }

    .btn.subtle {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.35);
      color: var(--text-muted);
    }

    .btn.small { padding: 4px 9px; font-size: 11px; }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .hint strong { color: var(--accent); }

    /* CANVAS */

    .canvas-row {
      display: grid;
      gap: 8px;
      margin-top: 8px;
    }

    @media (min-width: 760px) {
      .canvas-row { grid-template-columns: 3fr 2fr; }
    }

    .canvas-card {
      border-radius: 12px;
      background: radial-gradient(circle at top left, #020617, #020617);
      border: 1px solid rgba(31, 41, 55, 0.95);
      padding: 8px 9px 9px;
    }

    .canvas-title {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    canvas {
      width: 100%;
      height: 80px;
      border-radius: 10px;
      background: radial-gradient(circle at top, #020617, #000814);
      display: block;
    }

    .score-main {
      font-size: 20px;
      font-weight: 600;
      margin: 1px 0 4px;
    }

    .score-main.good { color: var(--success); }
    .score-main.bad  { color: var(--danger); }

    .score-detail {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .chip-row-soft {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 6px;
    }

    .chip-soft {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 99px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
    }

    /* LIPREADING */

    .lip-grid {
      display: grid;
      gap: 10px;
    }

    @media (min-width: 760px) {
      .lip-grid {
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr);
      }
    }

    .mouth-box {
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      padding: 10px;
      background: radial-gradient(circle at top, #020617, #020617 60%);
      text-align: center;
    }

    .mouth-symbol {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .mouth-desc {
      font-size: 12px;
      color: var(--text-muted);
      min-height: 30px;
    }

    .camera-box {
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      padding: 10px;
      background: radial-gradient(circle at top right, #020617, #020617 65%);
    }

    video {
      width: 100%;
      border-radius: 12px;
      background: #000;
      max-height: 220px;
      object-fit: cover;
    }

    .camera-status {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* TEACHER VIEW */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    thead { background: rgba(15, 23, 42, 0.95); }

    th, td {
      border: 1px solid rgba(31, 41, 55, 0.95);
      padding: 5px 6px;
      text-align: left;
    }

    th {
      color: var(--text-muted);
      font-weight: 500;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }

    .text-right { text-align: right; }
    .text-muted { color: var(--text-muted); }

    .log-list {
      max-height: 140px;
      overflow-y: auto;
      margin-top: 8px;
      padding-right: 2px;
    }

    .log-entry {
      font-size: 11px;
      color: var(--text-muted);
      padding: 2px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.9);
    }

    .alert {
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      margin-top: 6px;
    }

    .alert strong { color: var(--accent); }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="title-row">
        <div class="logo-circle">S</div>
        <div>
          <h1>SoundStudy for All Â· ë°ëª¨</h1>
          <p class="tagline">"ë“¤ì„ ìˆ˜ ì—†ì–´ë„, ë°œìŒê³¼ ë¦¬ë“¬ì„ ì‹œê°Â·ì´‰ê°ìœ¼ë¡œ ê²½í—˜í•  ìˆ˜ ìˆëŠ” ì—°ìŠµ ê³µê°„"</p>
        </div>
      </div>

      <div class="chip-row">
        <span class="chip primary">ì‹œê°ì  í”¼ë“œë°±</span>
        <span class="chip">ì§„ë™ ê¸°ë°˜ ë¦¬ë“¬</span>
        <span class="chip">AI ë°œìŒ ë¶„ì„(ë°ëª¨)</span>
        <span class="chip">ë¦½ë¦¬ë”© í•™ìŠµ</span>
        <span class="chip">ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜</span>
      </div>

      <!-- í•™ìŠµì ëª¨ë“œ: í†µí•© ìˆ˜ì—… / ì²­ê°ì¥ì•  ì¤‘ì‹¬ / ì¼ë°˜ í•™ìƒ -->
      <div class="mode-toggle">
        <span class="mode-label">í•™ìŠµì ëª¨ë“œ</span>
        <div class="mode-buttons">
          <button class="mode-btn active" data-mode="integrated">í†µí•© ìˆ˜ì—…</button>
          <button class="mode-btn" data-mode="deaf">ì²­ê°ì¥ì•  ì¤‘ì‹¬</button>
          <button class="mode-btn" data-mode="hearing">ì¼ë°˜ í•™ìƒ</button>
        </div>
      </div>

      <!-- ì²­ê°ì¥ì•  ì •ë„(ê°œì¸í™”) â€“ ì²­ê°ì¥ì•  ì¤‘ì‹¬ ëª¨ë“œì—ì„œ ì‚¬ìš© -->
      <div id="hearingLevelRow" class="mode-toggle" style="display:none;">
        <span class="mode-label">ì²­ê°ì¥ì•  ì •ë„ (ê°œì¸í™”)</span>
        <div class="mode-buttons">
          <button class="mode-btn small" data-hearing="mild">ê²½ë„/ë¶€ë¶„ ë‚œì²­</button>
          <button class="mode-btn small active" data-hearing="moderate">ì¤‘ë“±ë„</button>
          <button class="mode-btn small" data-hearing="severe">ê³ ë„Â·ë† ìˆ˜ì¤€</button>
        </div>
      </div>

      <nav class="nav">
        <button class="nav-btn active" data-target="panel-dashboard">
          <span class="icon">ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ
        </button>
        <button class="nav-btn" data-target="panel-pronunciation">
          <span class="icon">ğŸ™</span> ë°œìŒ ì‹¤í—˜ì‹¤
        </button>
        <button class="nav-btn" data-target="panel-lipreading">
          <span class="icon">ğŸ‘„</span> ë¦½ë¦¬ë”©
        </button>
        <button class="nav-btn" data-target="panel-teacher">
          <span class="icon">ğŸ“š</span> êµì‚¬ ë³´ê¸°
        </button>
      </nav>
    </header>

    <main>
      <!-- DASHBOARD -->
      <section id="panel-dashboard" class="panel">
        <h2>ë‚˜ì˜ í•™ìŠµ ìš”ì•½</h2>
        <p class="panel-subtitle">
          ë°œìŒ ì‹œë„, ì ìˆ˜, ë°°ì§€, ì‚¬ìš©í•œ ëª¨ë“ˆì„ í•œ ëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.
        </p>

        <div class="grid grid-2">
          <div class="card">
            <div class="card-header">
              <span class="card-title">ë ˆë²¨ & ê²½í—˜ì¹˜</span>
              <span class="badge-soft">AI ì—°ìŠµì ëª¨ë“œ</span>
            </div>
            <div class="level-display">
              <span id="levelLabel">Lv. 1 Â· í•™ìŠµì</span>
              <span style="font-size:12px;color:var(--text-muted);">100 XPë§ˆë‹¤ ë ˆë²¨ì—…</span>
            </div>
            <div class="xp-bar-wrapper">
              <div id="xpBar" class="xp-bar-fill"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <span class="card-title">ì—°ìŠµ í†µê³„</span>
              <span class="badge-soft">ê°€ìƒ ë°œìŒ í‰ê°€</span>
            </div>
            <div class="grid" style="grid-template-columns: repeat(2,minmax(0,1fr));gap:8px;">
              <div>
                <div id="statAttempts" class="stat-main">0íšŒ</div>
                <div class="stat-sub">ì´ ë°œìŒ ì‹œë„</div>
              </div>
              <div>
                <div id="statAvgScore" class="stat-main">-</div>
                <div class="stat-sub">í‰ê·  ì ìˆ˜</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <span class="card-title">ë°°ì§€</span>
              <span class="badge-soft">ë„ì „ê³¼ì œ</span>
            </div>
            <div class="stat-main" id="statBadges">0ê°œ</div>
            <div class="stat-sub">íšë“í•œ ë°°ì§€ ìˆ˜</div>
            <div class="pill-group" style="margin-top:6px;">
              <span class="pill" id="badge1Status">ê¾¸ì¤€í•œ ì—°ìŠµê°€ Â· ë¯¸íšë“</span>
              <span class="pill" id="badge2Status">ë¦¬ë“¬ ë§ˆìŠ¤í„° Â· ë¯¸íšë“</span>
              <span class="pill" id="badge3Status">ì™„ì£¼ëŸ¬ Â· ë¯¸íšë“</span>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <span class="card-title">ì‚¬ìš©í•œ ëª¨ë“ˆ</span>
              <span class="badge-soft">ë‹¤ì¤‘ê°ê° í•™ìŠµ</span>
            </div>
            <div class="pill-group">
              <span class="pill" id="usedPronunciation">ğŸ™ ë°œìŒ ì‹¤í—˜ì‹¤</span>
              <span class="pill" id="usedVibration">ğŸ“³ ì§„ë™ ë¦¬ë“¬</span>
              <span class="pill" id="usedLipreading">ğŸ‘„ ë¦½ë¦¬ë”©</span>
            </div>
            <button id="btnResetProgress" class="btn small subtle" style="margin-top:6px;">
              ì§„í–‰ë„ ì´ˆê¸°í™”
            </button>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <div class="card-header">
            <span class="card-title">ì´ë²¤íŠ¸ ë¡œê·¸</span>
            <span class="badge-soft">ìµœê·¼ í™œë™</span>
          </div>
          <div id="eventLog" class="log-list"></div>
        </div>
      </section>

      <!-- PRONUNCIATION LAB -->
      <section id="panel-pronunciation" class="panel" hidden>
        <h2>ë°œìŒ ì‹¤í—˜ì‹¤</h2>
        <p class="panel-subtitle">
          ëª©í‘œ ë¬¸ì¥ì„ ë§í•˜ë©´, íŒŒí˜•Â·ë¦¬ë“¬Â·ë³¼ë¥¨ê³¼ (ì§€ì› ë¸Œë¼ìš°ì €ì—ì„œëŠ”) ë¬¸ì¥ ìœ ì‚¬ë„ê¹Œì§€ ë¶„ì„í•´ ì£¼ëŠ” ì—°ìŠµ ê³µê°„ì…ë‹ˆë‹¤.
        </p>

        <div class="card">
          <label for="targetSentence">ğŸ¯ ëª©í‘œ ë¬¸ì¥</label>
          <input
            id="targetSentence"
            type="text"
            value="ì˜¤ëŠ˜ì€ ë°œìŒê³¼ ë¦¬ë“¬ì„ ì—°ìŠµí•´ ë³¼ê¹Œìš”?"
            placeholder="ì—°ìŠµí•˜ê³  ì‹¶ì€ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”"
          />
          <p class="hint">
            ë¬¸ì¥ì„ ë°”ê¿”ë„ ê´œì°®ì•„ìš”. <strong>ë…¹ìŒ ì‹œì‘ â†’ ë§í•˜ê¸° â†’ ë…¹ìŒ ì¢…ë£Œ â†’ ë¶„ì„</strong> ìˆœì„œë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
          </p>
          <p id="modeExplainPronunciation" class="hint"></p>

          <div class="btn-row">
            <button id="btnStartRecord" class="btn primary">
              <span>â—</span> ë…¹ìŒ ì‹œì‘
            </button>
            <button id="btnStopRecord" class="btn subtle" disabled>
              â–  ë…¹ìŒ ì¢…ë£Œ
            </button>
            <button id="btnAnalyze" class="btn subtle" disabled>
              âœ¨ ë¶„ì„
            </button>
          </div>
          <p id="sttStatus" class="hint" style="margin-top:6px;"></p>
        </div>

        <div class="canvas-row">
          <div class="canvas-card">
            <div class="canvas-title">
              <span>ì‹¤ì‹œê°„ íŒŒí˜• (ë¦¬ë“¬/ê°•ë„)</span>
              <span style="font-size:10px;color:var(--text-muted);">ì…Â·í˜¸í¡ ë¦¬ë“¬ì„ ëˆˆìœ¼ë¡œ ë³´ê¸°</span>
            </div>
            <canvas id="waveCanvas"></canvas>
          </div>
          <div class="canvas-card">
            <div class="canvas-title">
              <span>ê°„ë‹¨ ì£¼íŒŒìˆ˜ ë·°</span>
              <span style="font-size:10px;color:var(--text-muted);">ë‚®ì€/ë†’ì€ ì†Œë¦¬ ë¶„í¬</span>
            </div>
            <canvas id="freqCanvas"></canvas>
          </div>
        </div>

        <div class="grid" style="margin-top:10px;grid-template-columns: minmax(0,1.3fr) minmax(0,1.7fr);gap:10px;">
          <div class="card">
            <div class="card-header">
              <span class="card-title">ì ìˆ˜ & í”¼ë“œë°±</span>
              <span class="badge-soft">ë°ëª¨ìš© ëª¨ì˜ í‰ê°€</span>
            </div>
            <div id="scoreText" class="score-main">-</div>
            <div id="scoreDetail" class="score-detail">
              ì•„ì§ ë¶„ì„ì„ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìœ„ì˜ ë²„íŠ¼ìœ¼ë¡œ ë…¹ìŒ í›„ ë¶„ì„ì„ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”.
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <span class="card-title">ë¦¬ë“¬ Â· ê°•ì„¸ ìš”ì•½</span>
              <span class="badge-soft">ì‹œê° + ì´‰ê° í”¼ë“œë°±</span>
            </div>
            <div id="rhythmChips" class="chip-row-soft">
              <span class="chip-soft">ë°œìŒ ê¸¸ì´, ê°•ë„, ë¬¸ì¥ ìœ ì‚¬ë„ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš”ì•½ í”¼ë“œë°±ì´ ì œê³µë©ë‹ˆë‹¤.</span>
            </div>
            <div class="alert">
              <strong>ì§„ë™ ë¦¬ë“¬ ì²´í—˜</strong><br />
              ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ë¦¬ë“¬ì„ ì§„ë™ìœ¼ë¡œë„ ëŠê»´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              (ì¼ë¶€ ê¸°ê¸°/ë¸Œë¼ìš°ì €ëŠ” ì§„ë™ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
            </div>
            <div class="btn-row" style="margin-top:6px;">
              <button class="btn small" data-vibrate="rhythm">ğŸ“³ ë¦¬ë“¬ íŒ¨í„´</button>
              <button class="btn small" data-vibrate="stress">ğŸ“³ ê°•ì„¸ íŒ¨í„´</button>
              <button class="btn small" data-vibrate="combo">ğŸ“³ ë³µí•© íŒ¨í„´</button>
            </div>
            <p id="vibrationStatus" class="hint" style="margin-top:4px;"></p>
          </div>
        </div>
      </section>

      <!-- LIPREADING -->
      <section id="panel-lipreading" class="panel" hidden>
        <h2>ë¦½ë¦¬ë”© ì—°ìŠµ</h2>
        <p class="panel-subtitle">
          ê¸°ë³¸ ëª¨ìŒê³¼ ììŒì„ ì¤‘ì‹¬ìœ¼ë¡œ ì…ëª¨ì–‘ê³¼ í„±, ì…ìˆ ì˜ ì›€ì§ì„ì„ ì‹œê°ì ìœ¼ë¡œ ì—°ìŠµí•©ë‹ˆë‹¤. ì¹´ë©”ë¼ë¥¼ ì¼œë©´ ë‚´ ì…ëª¨ì–‘ë„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.
        </p>

        <div class="lip-grid">
          <div class="mouth-box">
            <div class="card-header" style="margin-bottom:4px;">
              <span class="card-title">í˜„ì¬ ì—°ìŠµ ìŒì†Œ</span>
              <span class="badge-soft">ê¸°ë³¸ ì…ëª¨ì–‘ ì„¸íŠ¸</span>
            </div>
            <div id="mouthShape" class="mouth-symbol">ì•„</div>
            <div id="mouthDesc" class="mouth-desc">
              ì…ì„ í¬ê²Œ ë²Œë¦¬ê³  í„±ì„ ì¶©ë¶„íˆ ë‚´ë ¤ ì£¼ì„¸ìš”.
            </div>
            <div class="btn-row" style="justify-content:center;margin-top:8px;">
              <button id="btnPrevMouth" class="btn small subtle">â† ì´ì „</button>
              <button id="btnNextMouth" class="btn small">ë‹¤ìŒ â†’</button>
            </div>
            <p class="hint" style="margin-top:6px;">
              ì…ëª¨ì–‘ì„ ì¶©ë¶„íˆ í¬ê²Œ, ì²œì²œíˆ ë§Œë“¤ì–´ ë³´ë©´ì„œ <strong>í„±Â·ì…ìˆ Â·í˜€ì˜ ìœ„ì¹˜</strong>ë¥¼ ì˜ì‹í•´ ë³´ì„¸ìš”.
            </p>
          </div>

          <div class="camera-box">
            <div class="card-header">
              <span class="card-title">ì¹´ë©”ë¼ ì…ëª¨ì–‘ í™•ì¸</span>
              <span class="badge-soft">ë‚´ ì…ëª¨ì–‘ ë¯¸ëŸ¬ë§</span>
            </div>
            <video id="lipCamera" autoplay playsinline muted></video>
            <p id="lipCamStatus" class="camera-status">
              ì•„ì§ ì¹´ë©”ë¼ê°€ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì¼œ ë³´ì„¸ìš”.
            </p>
            <div class="btn-row">
              <button id="btnStartLipCam" class="btn small">ì¹´ë©”ë¼ ì¼œê¸°</button>
              <button id="btnStopLipCam" class="btn small subtle" disabled>ì¹´ë©”ë¼ ë„ê¸°</button>
            </div>
            <p class="hint">
              ì¹´ë©”ë¼ ê¶Œí•œ í—ˆìš© í›„, í™”ë©´ ì† ì…ëª¨ì–‘ì„ ìœ„ì˜ ëª¨ì–‘ê³¼ ë¹„êµí•˜ë©° ì¡°ìŒ ìœ„ì¹˜ë¥¼ ì¡°ì •í•´ ë³´ì„¸ìš”.
            </p>
          </div>
        </div>
      </section>

      <!-- TEACHER VIEW -->
      <section id="panel-teacher" class="panel" hidden>
        <h2>êµì‚¬ ë³´ê¸° (ë¡œì»¬ ë°ëª¨)</h2>
        <p class="panel-subtitle">
          ì´ í™”ë©´ì€ ì‹¤ì œ ìˆ˜ì—…ì—ì„œ êµì‚¬ê°€ ë³´ëŠ” ê²ƒì²˜ëŸ¼, í•™ìƒì˜ ë°œìŒ ì‹œë„ ê¸°ë¡ê³¼ ì ìˆ˜ë¥¼ ê°€ë³ê²Œ ëª¨ì˜ ì²´í—˜í•˜ëŠ” ìš©ë„ì…ë‹ˆë‹¤.
          ëª¨ë“  ë°ì´í„°ëŠ” <strong>ë¸Œë¼ìš°ì €ì—ë§Œ ë¡œì»¬ ì €ì¥</strong>ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
        <p id="modeExplainTeacher" class="hint"></p>

        <div class="card" style="margin-bottom:10px;">
          <div class="card-header">
            <span class="card-title">ìµœê·¼ ë°œìŒ ì‹œë„</span>
            <span class="badge-soft">ìµœëŒ€ 20ê°œ ì €ì¥</span>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:70px;">ì‹œê°„</th>
                  <th>ëª©í‘œ ë¬¸ì¥</th>
                  <th>ì¸ì‹ëœ ë¬¸ì¥(ì§€ì› ë¸Œë¼ìš°ì €)</th>
                  <th class="text-right" style="width:60px;">ì ìˆ˜</th>
                  <th class="text-right" style="width:60px;">ê¸¸ì´(s)</th>
                </tr>
              </thead>
              <tbody id="historyTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">ë°ëª¨ ì„¤ëª…</span>
            <span class="badge-soft">ì£¼ì˜</span>
          </div>
          <ul style="margin:4px 0 0 16px;font-size:12px;color:var(--text-muted);padding-left:8px;">
            <li>ë°œìŒ í‰ê°€ëŠ” <strong>ì—°êµ¬ìš©/ì‹œì—°ìš© ëª¨ì˜ ì•Œê³ ë¦¬ì¦˜</strong>ìœ¼ë¡œ, ì‹¤ì œ ì§„ë‹¨ ë„êµ¬ê°€ ì•„ë‹™ë‹ˆë‹¤.</li>
            <li>ì ìˆ˜ëŠ” ë°œí™” ê¸¸ì´, ë³¼ë¥¨, (ì§€ì› ë¸Œë¼ìš°ì €ì—ì„œëŠ”) ëª©í‘œ ë¬¸ì¥ê³¼ì˜ í…ìŠ¤íŠ¸ ìœ ì‚¬ë„ë¥¼ ì¡°í•©í•´ ê³„ì‚°í•©ë‹ˆë‹¤.</li>
            <li>ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ë³„ë„ì˜ AI ì„œë²„ì™€ ë³´ì•ˆ ì •ì±…, í•™ìŠµ ë°ì´í„° ê´€ë¦¬ ì²´ê³„ê°€ ì¶”ê°€ë¡œ í•„ìš”í•©ë‹ˆë‹¤.</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <script>
    "use strict";

    // ----------------------
    // ê³µí†µ ìƒíƒœ & ìœ í‹¸
    // ----------------------
    const state = {
      xp: 0,
      level: 1,
      attempts: 0,
      totalScore: 0,
      badges: {
        consistency: false,
        rhythmMaster: false,
        allModules: false
      },
      usedModules: {
        pronunciation: false,
        vibration: false,
        lipreading: false
      },
      history: [], // {time, target, recognized, score, durationSec}
      learnerMode: "integrated", // í†µí•© ìˆ˜ì—… / ì²­ê°ì¥ì•  ì¤‘ì‹¬ / ì¼ë°˜ í•™ìƒ
      hearingLevel: "moderate"   // mild / moderate / severe (ê°œì¸í™”)
    };

    const STORAGE_KEY = "soundstudy_demo_state_v3";

    function logEvent(message) {
      const log = document.getElementById("eventLog");
      if (!log) return;
      const div = document.createElement("div");
      div.className = "log-entry";
      const now = new Date();
      const time = now.toTimeString().slice(0, 5);
      div.textContent = `[${time}] ${message}`;
      log.prepend(div);
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn("saveState error:", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          Object.assign(state, data);
        }
      } catch (e) {
        console.warn("loadState error:", e);
      }
      updateAllUI();
    }

    function addXP(amount) {
      state.xp += amount;
      const newLevel = Math.floor(state.xp / 100) + 1;
      if (newLevel > state.level) {
        state.level = newLevel;
        logEvent(`ë ˆë²¨ ì—…! í˜„ì¬ ë ˆë²¨: ${state.level}`);
      }
      updateDashboard();
      saveState();
    }

    function updateBadgesAndStats() {
      // ë°°ì§€: 5íšŒ ì´ìƒ ì—°ìŠµ
      if (state.attempts >= 5 && !state.badges.consistency) {
        state.badges.consistency = true;
        logEvent("ë°°ì§€ íšë“: ê¾¸ì¤€í•œ ì—°ìŠµê°€");
      }

      const avgScore = state.attempts > 0
        ? Math.round(state.totalScore / state.attempts)
        : 0;

      if (avgScore >= 80 && !state.badges.rhythmMaster) {
        state.badges.rhythmMaster = true;
        logEvent("ë°°ì§€ íšë“: ë¦¬ë“¬ ë§ˆìŠ¤í„°");
      }

      if (
        state.usedModules.pronunciation &&
        state.usedModules.vibration &&
        state.usedModules.lipreading &&
        !state.badges.allModules
      ) {
        state.badges.allModules = true;
        logEvent("ë°°ì§€ íšë“: ì™„ì£¼ëŸ¬");
      }

      updateDashboard();
      saveState();
    }

    function updateDashboard() {
      const xpBar = document.getElementById("xpBar");
      const levelLabel = document.getElementById("levelLabel");
      const statAttempts = document.getElementById("statAttempts");
      const statAvgScore = document.getElementById("statAvgScore");
      const statBadges = document.getElementById("statBadges");

      const currentLevelXp = state.xp % 100;
      const percent = Math.max(5, Math.min(100, (currentLevelXp / 100) * 100));
      if (xpBar) xpBar.style.width = percent + "%";
      if (levelLabel) levelLabel.textContent = `Lv. ${state.level} Â· í•™ìŠµì`;

      if (statAttempts) statAttempts.textContent = state.attempts + "íšŒ";
      const avgScore = state.attempts > 0
        ? Math.round(state.totalScore / state.attempts)
        : 0;
      if (statAvgScore) {
        statAvgScore.textContent = state.attempts > 0 ? avgScore + "ì " : "-";
      }

      const badgeCount =
        (state.badges.consistency ? 1 : 0) +
        (state.badges.rhythmMaster ? 1 : 0) +
        (state.badges.allModules ? 1 : 0);
      if (statBadges) statBadges.textContent = badgeCount + "ê°œ";

      const badge1 = document.getElementById("badge1Status");
      const badge2 = document.getElementById("badge2Status");
      const badge3 = document.getElementById("badge3Status");

      if (badge1) {
        badge1.textContent =
          "ê¾¸ì¤€í•œ ì—°ìŠµê°€ Â· " + (state.badges.consistency ? "íšë“ ì™„ë£Œ" : "ë¯¸íšë“");
        badge1.classList.toggle("good", state.badges.consistency);
      }
      if (badge2) {
        badge2.textContent =
          "ë¦¬ë“¬ ë§ˆìŠ¤í„° Â· " + (state.badges.rhythmMaster ? "íšë“ ì™„ë£Œ" : "ë¯¸íšë“");
        badge2.classList.toggle("good", state.badges.rhythmMaster);
      }
      if (badge3) {
        badge3.textContent =
          "ì™„ì£¼ëŸ¬ Â· " + (state.badges.allModules ? "íšë“ ì™„ë£Œ" : "ë¯¸íšë“");
        badge3.classList.toggle("good", state.badges.allModules);
      }

      // ì‚¬ìš© ëª¨ë“ˆ pill
      const usedPron = document.getElementById("usedPronunciation");
      const usedVib = document.getElementById("usedVibration");
      const usedLip = document.getElementById("usedLipreading");

      if (usedPron) {
        usedPron.classList.toggle("good", state.usedModules.pronunciation);
      }
      if (usedVib) {
        usedVib.classList.toggle("good", state.usedModules.vibration);
      }
      if (usedLip) {
        usedLip.classList.toggle("good", state.usedModules.lipreading);
      }
    }

    function rebuildHistoryTable() {
      const body = document.getElementById("historyTableBody");
      if (!body) return;
      body.innerHTML = "";
      if (!state.history || state.history.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "text-muted";
        td.textContent = "ì•„ì§ ë°œìŒ ì‹œë„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
        tr.appendChild(td);
        body.appendChild(tr);
        return;
      }
      state.history.forEach((item) => {
        const tr = document.createElement("tr");
        const tdTime = document.createElement("td");
        const tdTarget = document.createElement("td");
        const tdRecog = document.createElement("td");
        const tdScore = document.createElement("td");
        const tdDur = document.createElement("td");

        tdTime.textContent = item.time;
        tdTarget.textContent = item.target || "";
        tdRecog.textContent = item.recognized || "-";
        tdScore.textContent = item.score + "ì ";
        tdScore.className = "text-right";
        tdDur.textContent = item.durationSec.toFixed(1);
        tdDur.className = "text-right";

        tr.appendChild(tdTime);
        tr.appendChild(tdTarget);
        tr.appendChild(tdRecog);
        tr.appendChild(tdScore);
        tr.appendChild(tdDur);
        body.appendChild(tr);
      });
    }

    function updateModeUI() {
      const mode = state.learnerMode || "integrated";
      const modeButtons = document.querySelectorAll(".mode-btn[data-mode]");
      modeButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.getAttribute("data-mode") === mode);
      });

      const hearingRow = document.getElementById("hearingLevelRow");
      if (hearingRow) {
        hearingRow.style.display = mode === "deaf" ? "flex" : "none";
      }

      const modeExplainPron = document.getElementById("modeExplainPronunciation");
      const modeExplainTeacher = document.getElementById("modeExplainTeacher");

      const level = state.hearingLevel || "moderate";

      let pronText = "";
      let teacherText = "";

      if (mode === "integrated") {
        pronText =
          "í†µí•© ìˆ˜ì—… ëª¨ë“œì…ë‹ˆë‹¤. ê°™ì€ ë¬¸ì¥ì„ ë‘ í•™ìƒì´ í•¨ê»˜ ì—°ìŠµí•˜ë˜, ì²­ê°ì¥ì•  í•™ìƒì€ ì‹œê°Â·ì´‰ê° í”¼ë“œë°±ì„, ì¼ë°˜ í•™ìƒì€ ì²­ê°Â·ì‹œê° í”¼ë“œë°±ì„ ì¤‘ì‹¬ìœ¼ë¡œ í™œìš©í•˜ëŠ” ìƒí™©ì„ ê°€ì •í•©ë‹ˆë‹¤.";
        teacherText =
          "í†µí•© ìˆ˜ì—… ëª¨ë“œ: ë™ì¼í•œ í™œë™ ì•ˆì—ì„œ ë‘ ì§‘ë‹¨ì˜ ë°œìŒ íŒ¨í„´Â·ë¦¬ë“¬ ì°¨ì´ë¥¼ ë¹„êµí•˜ëŠ” ë° ì´ˆì ì„ ë‘¡ë‹ˆë‹¤.";
      } else if (mode === "deaf") {
        if (level === "mild") {
          pronText =
            "ì²­ê°ì¥ì•  ì¤‘ì‹¬ ëª¨ë“œ Â· ê²½ë„/ë¶€ë¶„ ë‚œì²­ í”„ë¡œí•„ì…ë‹ˆë‹¤. ë“¤ë¦¬ëŠ” ì†Œë¦¬ì™€ íŒŒí˜•Â·í…ìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ë³´ë©°, ì‹œê°ì  í”¼ë“œë°±ì„ ë³´ì¡° ë„êµ¬ë¡œ ì‚¬ìš©í•˜ëŠ” ì—°ìŠµì— ì´ˆì ì„ ë‘¡ë‹ˆë‹¤.";
          teacherText =
            "ê²½ë„/ë¶€ë¶„ ë‚œì²­ í”„ë¡œí•„: ì¼ë°˜ ìŒì„± ì •ë³´ì— ì ‘ê·¼ì€ ê°€ëŠ¥í•˜ì§€ë§Œ, ì†ŒìŒÂ·êµì‹¤ í™˜ê²½ì—ì„œ ì‹œê° í”¼ë“œë°±ì´ ì–¼ë§ˆë‚˜ ë„ì›€ì„ ì£¼ëŠ”ì§€ì— ì£¼ëª©í•˜ì—¬ ë°ì´í„°ë¥¼ í•´ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
        } else if (level === "moderate") {
          pronText =
            "ì²­ê°ì¥ì•  ì¤‘ì‹¬ ëª¨ë“œ Â· ì¤‘ë“±ë„ í”„ë¡œí•„ì…ë‹ˆë‹¤. íŒŒí˜•Â·ì£¼íŒŒìˆ˜Â·í…ìŠ¤íŠ¸ í”¼ë“œë°±ì„ ë™ì‹œì— í™œìš©í•˜ë©°, ì†Œë¦¬ ì—†ì´ë„ ë°œìŒ êµ¬ì¡°ë¥¼ íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ëœ ì—°ìŠµì„ ê°€ì •í•©ë‹ˆë‹¤.";
          teacherText =
            "ì¤‘ë“±ë„ í”„ë¡œí•„: ë³´ì¡°ê¸°ê¸°Â·ìë§‰ê³¼ í•¨ê»˜ ë‹¤ì¤‘ê°ê° í”¼ë“œë°±ì„ ë³‘í–‰í•˜ëŠ” ìƒí™©ì„ ê°€ì •í•˜ë©°, ì‹œê°Â·ì´‰ê° í”¼ë“œë°±ì˜ ê¸°ì—¬ë„ë¥¼ ê´€ì°°í•˜ëŠ” ë° ì í•©í•©ë‹ˆë‹¤.";
        } else {
          pronText =
            "ì²­ê°ì¥ì•  ì¤‘ì‹¬ ëª¨ë“œ Â· ê³ ë„Â·ë† ìˆ˜ì¤€ í”„ë¡œí•„ì…ë‹ˆë‹¤. ì†Œë¦¬ë¥¼ ë“£ì§€ ëª»í•´ë„ íŒŒí˜•Â·ì£¼íŒŒìˆ˜Â·ì§„ë™ í”¼ë“œë°±ë§Œìœ¼ë¡œ ë°œìŒê³¼ ë¦¬ë“¬ì„ ì´í•´í•˜ëŠ” ì—°ìŠµì— ì´ˆì ì„ ë‘¡ë‹ˆë‹¤.";
          teacherText =
            "ê³ ë„Â·ë† ìˆ˜ì¤€ í”„ë¡œí•„: ì²­ê° ì •ë³´ ì—†ì´ë„ ì˜ì‚¬ì†Œí†µì´ ê°€ëŠ¥í•˜ë„ë¡, ì‹œê°Â·ì´‰ê° ì±„ë„ë§Œìœ¼ë¡œ ë°œìŒ í”¼ë“œë°±ì„ êµ¬ì„±í–ˆì„ ë•Œì˜ í•œê³„ì™€ ê°€ëŠ¥ì„±ì„ ì‚´í´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
        }
      } else if (mode === "hearing") {
        pronText =
          "ì¼ë°˜ í•™ìƒ ëª¨ë“œì…ë‹ˆë‹¤. ê·€ë¡œ ë“¤ë¦¬ëŠ” ì†Œë¦¬ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì—°ìŠµí•˜ë˜, ì²­ê°ì¥ì•  í•™ìƒê³¼ ë™ì¼í•œ í™”ë©´ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•´ ì‹œê° í”¼ë“œë°±ì„ ë³´ì¡°ì ìœ¼ë¡œ í™œìš©í•©ë‹ˆë‹¤.";
        teacherText =
          "ì¼ë°˜ í•™ìƒ ëª¨ë“œ: ë™ì¼í•œ UIë¥¼ ì‚¬ìš©í•˜ë©´ì„œ ì²­ê° ì •ë³´ê°€ ì¶”ê°€ëœ ì§‘ë‹¨ê³¼ì˜ ë°œìŒÂ·ë¦¬ë“¬ ì°¨ì´ë¥¼ ë¹„êµ ë¶„ì„í•˜ëŠ” ë° í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      }

      if (modeExplainPron) modeExplainPron.textContent = pronText;
      if (modeExplainTeacher) modeExplainTeacher.textContent = teacherText;

      updateHearingLevelUI();
    }

    function updateHearingLevelUI() {
      const buttons = document.querySelectorAll(".mode-btn[data-hearing]");
      buttons.forEach((btn) => {
        btn.classList.toggle(
          "active",
          btn.getAttribute("data-hearing") === state.hearingLevel
        );
      });
    }

    function updateAllUI() {
      updateDashboard();
      rebuildHistoryTable();
      updateModeUI();
    }

    // ----------------------
    // ë„¤ë¹„ê²Œì´ì…˜
    // ----------------------
    document.querySelectorAll(".nav-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-target");
        document.querySelectorAll(".nav-btn").forEach((b) =>
          b.classList.remove("active")
        );
        btn.classList.add("active");
        document.querySelectorAll("main > section").forEach((panel) => {
          panel.hidden = panel.id !== targetId;
        });
      });
    });

    // ----------------------
    // ë°œìŒ ì‹¤í—˜ì‹¤: Web Audio + (ê°€ëŠ¥í•˜ë©´) STT
    // ----------------------
    let audioContext = null;
    let analyserTime = null;
    let analyserFreq = null;
    let mediaStream = null;
    let waveAnimationId = null;
    let freqAnimationId = null;
    let timeDataArray = null;
    let freqDataArray = null;
    let recordingStartTime = 0;
    let lastRMS = 0;
    let hasSample = false;

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    const supportsSTT = !!SpeechRecognition && !isIOS;

    let recognition = null;
    let recognizedText = "";

    const waveCanvas = document.getElementById("waveCanvas");
    const freqCanvas = document.getElementById("freqCanvas");
    const waveCtx = waveCanvas.getContext("2d");
    const freqCtx = freqCanvas.getContext("2d");

    function resizeCanvases() {
      [waveCanvas, freqCanvas].forEach((c) => {
        const rect = c.getBoundingClientRect();
        c.width = rect.width * window.devicePixelRatio;
        c.height = rect.height * window.devicePixelRatio;
      });
    }

    window.addEventListener("resize", resizeCanvases);
    resizeCanvases();

    function drawWaveform() {
      if (!analyserTime || !waveCtx) return;
      const bufferLength = analyserTime.fftSize;
      if (!timeDataArray || timeDataArray.length !== bufferLength) {
        timeDataArray = new Uint8Array(bufferLength);
      }
      analyserTime.getByteTimeDomainData(timeDataArray);

      const width = waveCanvas.width;
      const height = waveCanvas.height;
      waveCtx.clearRect(0, 0, width, height);

      waveCtx.fillStyle = "#020617";
      waveCtx.fillRect(0, 0, width, height);

      waveCtx.strokeStyle = "rgba(148,163,184,0.4)";
      waveCtx.lineWidth = 1 * window.devicePixelRatio;
      waveCtx.beginPath();
      waveCtx.moveTo(0, height / 2);
      waveCtx.lineTo(width, height / 2);
      waveCtx.stroke();

      waveCtx.lineWidth = 2.4 * window.devicePixelRatio;
      waveCtx.strokeStyle = "#38bdf8";
      waveCtx.beginPath();

      const sliceWidth = width / bufferLength;
      let x = 0;
      let sumSquares = 0;

      for (let i = 0; i < bufferLength; i++) {
        const v = timeDataArray[i] / 128.0 - 1.0;
        const y = height / 2 + v * (height / 2) * 0.9;
        if (i === 0) {
          waveCtx.moveTo(x, y);
        } else {
          waveCtx.lineTo(x, y);
        }
        x += sliceWidth;
        sumSquares += v * v;
      }
      waveCtx.stroke();

      const rms = Math.sqrt(sumSquares / bufferLength);
      lastRMS = rms;

      waveAnimationId = requestAnimationFrame(drawWaveform);
    }

    function drawFrequency() {
      if (!analyserFreq || !freqCtx) return;
      const bufferLength = analyserFreq.frequencyBinCount;
      if (!freqDataArray || freqDataArray.length !== bufferLength) {
        freqDataArray = new Uint8Array(bufferLength);
      }
      analyserFreq.getByteFrequencyData(freqDataArray);

      const width = freqCanvas.width;
      const height = freqCanvas.height;
      freqCtx.clearRect(0, 0, width, height);
      freqCtx.fillStyle = "#020617";
      freqCtx.fillRect(0, 0, width, height);

      const barCount = 24;
      const binSize = Math.floor(bufferLength / barCount);
      const barWidth = (width / barCount) * 0.7;
      const gap = (width / barCount) * 0.3;

      for (let i = 0; i < barCount; i++) {
        const start = i * binSize;
        let sum = 0;
        for (let j = 0; j < binSize; j++) {
          sum += freqDataArray[start + j];
        }
        const avg = sum / binSize;
        const norm = avg / 255;
        const barHeight = norm * height;

        const x = i * (barWidth + gap);
        const y = height - barHeight;
        const grad = freqCtx.createLinearGradient(x, y, x, height);
        grad.addColorStop(0, "#38bdf8");
        grad.addColorStop(1, "#0f172a");
        freqCtx.fillStyle = grad;
        freqCtx.fillRect(x, y, barWidth, barHeight);
      }

      freqAnimationId = requestAnimationFrame(drawFrequency);
    }

    function editDistance(a, b) {
      a = a || "";
      b = b || "";
      const m = a.length;
      const n = b.length;
      const dp = Array.from({ length: m + 1 }, () =>
        new Array(n + 1).fill(0)
      );
      for (let i = 0; i <= m; i++) dp[i][0] = i;
      for (let j = 0; j <= n; j++) dp[0][j] = j;
      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + cost
          );
        }
      }
      return dp[m][n];
    }

    function similarityRatio(a, b) {
      a = (a || "").replace(/\s+/g, "");
      b = (b || "").replace(/\s+/g, "");
      if (!a.length && !b.length) return 1;
      const dist = editDistance(a, b);
      const maxLen = Math.max(a.length, b.length) || 1;
      return 1 - dist / maxLen;
    }

    async function startRecording() {
      const btnStart = document.getElementById("btnStartRecord");
      const btnStop = document.getElementById("btnStopRecord");
      const btnAnalyze = document.getElementById("btnAnalyze");

      try {
        state.usedModules.pronunciation = true;
        updateBadgesAndStats();

        btnStart.disabled = true;
        btnStop.disabled = false;
        btnAnalyze.disabled = true;

        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioContext.createMediaStreamSource(mediaStream);

        analyserTime = audioContext.createAnalyser();
        analyserTime.fftSize = 1024;
        source.connect(analyserTime);

        analyserFreq = audioContext.createAnalyser();
        analyserFreq.fftSize = 2048;
        source.connect(analyserFreq);

        recordingStartTime = performance.now();
        hasSample = false;
        recognizedText = "";

        resizeCanvases();
        drawWaveform();
        drawFrequency();

        if (supportsSTT) {
          if (!recognition) {
            recognition = new SpeechRecognition();
            recognition.lang = "ko-KR";
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
          }
          recognition.onresult = (event) => {
            if (event.results && event.results[0] && event.results[0][0]) {
              recognizedText = event.results[0][0].transcript.trim();
              logEvent(`ìŒì„± ì¸ì‹: "${recognizedText}"`);
            }
          };
          recognition.onerror = (e) => {
            console.warn("STT error:", e);
            logEvent("ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          };
          recognition.start();
          logEvent("ë…¹ìŒ + ìŒì„± ì¸ì‹ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.");
        } else {
          logEvent("ë…¹ìŒì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤. (ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)");
        }
      } catch (err) {
        console.error("ë…¹ìŒ ì‹œì‘ ì‹¤íŒ¨:", err);
        alert("ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
        btnStart.disabled = false;
        btnStop.disabled = true;
        btnAnalyze.disabled = true;
      }
    }

    function stopRecording() {
      const btnStart = document.getElementById("btnStartRecord");
      const btnStop = document.getElementById("btnStopRecord");
      const btnAnalyze = document.getElementById("btnAnalyze");

      btnStop.disabled = true;
      hasSample = true;
      btnAnalyze.disabled = false;
      btnStart.disabled = false;

      if (mediaStream) {
        mediaStream.getTracks().forEach((t) => t.stop());
        mediaStream = null;
      }
      if (waveAnimationId) {
        cancelAnimationFrame(waveAnimationId);
        waveAnimationId = null;
      }
      if (freqAnimationId) {
        cancelAnimationFrame(freqAnimationId);
        freqAnimationId = null;
      }

      if (supportsSTT && recognition) {
        try {
          recognition.stop();
        } catch (e) {
          console.warn("recognition stop error:", e);
        }
      }

      logEvent("ë…¹ìŒì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.");
    }

    function analyzeRecording() {
      if (!hasSample) {
        alert("ë¨¼ì € ë…¹ìŒì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const targetSentence = document.getElementById("targetSentence").value;
      const durationMs = performance.now() - recordingStartTime;
      const durationSec = durationMs / 1000;

      // ë¦¬ë“¬/ê¸¸ì´ ê¸°ë°˜ ì ìˆ˜
      const lengthScore =
        durationSec < 0.7
          ? 20
          : durationSec > 4
          ? 40
          : 60 + Math.max(0, 40 - Math.abs(durationSec - 2.0) * 15);

      const loudnessScore =
        lastRMS <= 0.02
          ? 20
          : lastRMS >= 0.3
          ? 50
          : 50 + lastRMS * 100;

      let prosodyScore = Math.round((lengthScore + loudnessScore) / 2);
      prosodyScore = Math.max(10, Math.min(100, prosodyScore));
      if (durationSec < 0.8) prosodyScore = Math.max(5, prosodyScore - 25);

      // ë‚´ìš©(ë¬¸ì¥ ìœ ì‚¬ë„) ì ìˆ˜
      let contentScore;
      let sim = 0;
      if (supportsSTT && recognizedText) {
        sim = similarityRatio(targetSentence, recognizedText);
        contentScore = Math.round(30 + sim * 70);
        contentScore = Math.max(10, Math.min(100, contentScore));
      } else if (supportsSTT && !recognizedText) {
        contentScore = 30;
      } else {
        contentScore = prosodyScore; // STT ì—†ëŠ” í™˜ê²½
      }

      let finalScore = Math.round(contentScore * 0.6 + prosodyScore * 0.4);
      finalScore = Math.max(10, Math.min(100, finalScore));

      state.attempts += 1;
      state.totalScore += finalScore;
      addXP(30);

      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");

      state.history.unshift({
        time: `${hh}:${mm}`,
        target: targetSentence,
        recognized: recognizedText,
        score: finalScore,
        durationSec: durationSec
      });
      if (state.history.length > 20) state.history.pop();

      updateBadgesAndStats();
      rebuildHistoryTable();

      const scoreText = document.getElementById("scoreText");
      const scoreDetail = document.getElementById("scoreDetail");
      const rhythmChips = document.getElementById("rhythmChips");

      if (scoreText) {
        scoreText.textContent = finalScore + "ì ";
        scoreText.classList.toggle("good", finalScore >= 75);
        scoreText.classList.toggle("bad", finalScore < 50);
      }

      const recognizedInfo = supportsSTT
        ? recognizedText
          ? `ì¸ì‹ëœ ë¬¸ì¥: "${recognizedText}"`
          : "ì¸ì‹ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤."
        : "ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ ë¬¸ì¥ ìœ ì‚¬ë„ëŠ” ëª¨ì˜ ê°’ì…ë‹ˆë‹¤.";

      const simInfo = supportsSTT
        ? `ëª©í‘œ ë¬¸ì¥ê³¼ì˜ ìœ ì‚¬ë„: ${(sim * 100).toFixed(0)}%`
        : "";

      const lengthDesc =
        durationSec < 1.0
          ? "ë°œìŒ ê¸¸ì´ê°€ ì¡°ê¸ˆ ì§§ì•„ìš”. í•œ ë°•ìë§Œ ë” ê¸¸ê²Œ ë§í•´ ë³¼ê¹Œìš”?"
          : durationSec > 4.0
          ? "ì¡°ê¸ˆ ê¸´ í¸ì´ì—ìš”. ìì—°ìŠ¤ëŸ½ê²Œ ëŠì–´ ì½ëŠ” ì—°ìŠµì„ í•´ ë´…ì‹œë‹¤."
          : "ê¸¸ì´ëŠ” ì ì ˆí•©ë‹ˆë‹¤. ë¦¬ë“¬ê³¼ ê°•ì„¸ë¥¼ ë” ì‹ ê²½ ì¨ ë³¼ê¹Œìš”?";

      const loudDesc =
        lastRMS < 0.03
          ? "ëª©ì†Œë¦¬ê°€ ì‘ê²Œ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤. ì•½ê°„ ë” í˜ ìˆê²Œ ë°œìŒí•´ ì£¼ì„¸ìš”."
          : lastRMS > 0.25
          ? "ì¶©ë¶„íˆ í¬ê²Œ ë°œìŒí–ˆì–´ìš”. ë„ˆë¬´ í˜ì„ ì£¼ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ìš”."
          : "ë³¼ë¥¨ë„ ì ë‹¹í•©ë‹ˆë‹¤. ì…ëª¨ì–‘ê³¼ ë¦¬ë“¬ì— ì§‘ì¤‘í•´ ë´…ì‹œë‹¤.";

      if (scoreDetail) {
        scoreDetail.textContent =
          `ëª©í‘œ ë¬¸ì¥: "${targetSentence}" Â· ë…¹ìŒ ì‹œê°„: ${durationSec.toFixed(
            1
          )}ì´ˆ Â· ë‚´ìš© ì ìˆ˜: ${contentScore} / ë¦¬ë“¬Â·ê°•ë„ ì ìˆ˜: ${prosodyScore}. ` +
          recognizedInfo +
          (simInfo ? " Â· " + simInfo : "") +
          " " +
          lengthDesc +
          " " +
          loudDesc;
      }

      if (rhythmChips) {
        rhythmChips.innerHTML = "";
        const chip1 = document.createElement("span");
        chip1.className = "chip-soft";
        if (durationSec < 1.0) {
          chip1.textContent = "ë¦¬ë“¬: ë„ˆë¬´ ë¹ ë¦„ Â· í•œ ë°•ì ë” ê¸¸ê²Œ";
        } else if (durationSec > 3.5) {
          chip1.textContent = "ë¦¬ë“¬: ì•½ê°„ ëŠë¦¼ Â· í˜¸í¡ì„ ë‚˜ëˆ„ì–´ ë³´ì„¸ìš”";
        } else {
          chip1.textContent = "ë¦¬ë“¬: ì•ˆì •ì  Â· ì§€ê¸ˆ ë¦¬ë“¬ì„ ìœ ì§€í•´ ë³´ì„¸ìš”";
        }
        const chip2 = document.createElement("span");
        chip2.className = "chip-soft";
        chip2.textContent =
          lastRMS < 0.03
            ? "ê°•ë„: ì‘ì€ í¸ Â· ì—ë„ˆì§€ë¥¼ ì¡°ê¸ˆ ë”"
            : lastRMS > 0.25
            ? "ê°•ë„: ê°•í•œ í¸ Â· ë¶€ë“œëŸ½ê²Œ ì¡°ì ˆ"
            : "ê°•ë„: ì ë‹¹í•¨ Â· ì¢‹ìŠµë‹ˆë‹¤!";

        const chip3 = document.createElement("span");
        chip3.className = "chip-soft";

        const mode = state.learnerMode;
        const level = state.hearingLevel;

        if (mode === "deaf") {
          if (level === "mild") {
            chip3.textContent = supportsSTT
              ? "TIP: íŒŒí˜•ê³¼ í•¨ê»˜ ì¸ì‹ëœ ë¬¸ì¥ì„ ë¹„êµí•˜ë©°, ë§ì†Œë¦¬ì™€ ì‹œê° í”¼ë“œë°±ì„ í•¨ê»˜ í™œìš©í•´ ë³´ì„¸ìš”."
              : "TIP: íŒŒí˜•ì„ ë³´ë©´ì„œ, ì–´ëŠ êµ¬ê°„ì—ì„œ ë°œìŒì´ ì•½í•´ì§€ëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸í•´ ë³´ì„¸ìš”.";
          } else if (level === "moderate") {
            chip3.textContent = supportsSTT
              ? "TIP: ì†Œë¦¬ë¥¼ ë“£ê¸° ì–´ë µë‹¤ê³  ëŠê»´ì§€ëŠ” êµ¬ê°„ì„ íŒŒí˜•Â·í…ìŠ¤íŠ¸ë¡œ í‘œì‹œí•´ ë‘ê³  ë°˜ë³µ ì—°ìŠµí•´ ë³´ì„¸ìš”."
              : "TIP: íŒŒí˜•ì˜ í¬ê¸°Â·ë¦¬ë“¬ì„ ê¸°ì¤€ìœ¼ë¡œ, íŠ¹ì • ìŒì ˆì„ ë” ê¸¸ê²Œ/ì§§ê²Œ ì¡°ì ˆí•´ ë³´ëŠ” ì—°ìŠµì„ í•´ ë³´ì„¸ìš”.";
          } else {
            chip3.textContent = "TIP: ì†Œë¦¬ ëŒ€ì‹  íŒŒí˜•ê³¼ ì§„ë™ì— ì§‘ì¤‘í•´, ì…ëª¨ì–‘Â·í˜¸í¡ ë¦¬ë“¬ì„ ëª¸ìœ¼ë¡œ ê¸°ì–µí•´ ë³´ì„¸ìš”.";
          }
        } else {
          chip3.textContent = supportsSTT
            ? "TIP: ê°™ì€ ë¬¸ì¥ì„ ì—¬ëŸ¬ ë²ˆ ë§í•˜ë©´ì„œ ìœ ì‚¬ë„% ë³€í™”ë¥¼ ê´€ì°°í•´ ë³´ì„¸ìš”."
            : "TIP: ì´ í™˜ê²½ì—ì„œëŠ” ë¦¬ë“¬Â·ë³¼ë¥¨ ì¤‘ì‹¬ í”¼ë“œë°±ë§Œ ì œê³µí•©ë‹ˆë‹¤.";
        }

        rhythmChips.appendChild(chip1);
        rhythmChips.appendChild(chip2);
        rhythmChips.appendChild(chip3);
      }

      logEvent(`ë°œìŒ ë¶„ì„ ì™„ë£Œ Â· ìµœì¢… ì ìˆ˜ ${finalScore}ì `);
      saveState();
    }

    document
      .getElementById("btnStartRecord")
      .addEventListener("click", startRecording);
    document
      .getElementById("btnStopRecord")
      .addEventListener("click", stopRecording);
    document
      .getElementById("btnAnalyze")
      .addEventListener("click", analyzeRecording);

    // STT ìƒíƒœ ì•ˆë‚´
    (function initSTTStatus() {
      const sttStatus = document.getElementById("sttStatus");
      if (!sttStatus) return;
      if (supportsSTT) {
        sttStatus.textContent =
          "ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤. ë§í•œ ë¬¸ì¥ì„ ìë™ìœ¼ë¡œ ì¸ì‹í•´ ëª©í‘œ ë¬¸ì¥ê³¼ì˜ ìœ ì‚¬ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.";
      } else if (isIOS) {
        sttStatus.textContent =
          "iOS(ì•„ì´í°/ì•„ì´íŒ¨ë“œ) ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ APIê°€ ì§€ì›ë˜ì§€ ì•Šì•„, ë¦¬ë“¬Â·ë³¼ë¥¨ ì¤‘ì‹¬ì˜ ëª¨ì˜ í‰ê°€ë§Œ ì œê³µë©ë‹ˆë‹¤.";
      } else {
        sttStatus.textContent =
          "ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  ë¦¬ë“¬Â·ë³¼ë¥¨ ì¤‘ì‹¬ì˜ ëª¨ì˜ í‰ê°€ê°€ ì œê³µë©ë‹ˆë‹¤.";
      }
    })();

    // ----------------------
    // ì§„ë™ ì œì–´
    // ----------------------
    const vibrationStatus = document.getElementById("vibrationStatus");
    const supportsVibration = "vibrate" in navigator && !isIOS;

    if (vibrationStatus) {
      if (isIOS) {
        vibrationStatus.textContent =
          "iOS ë¸Œë¼ìš°ì €ëŠ” ì›¹ ì§„ë™ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‹¤ì œ ì•± ë²„ì „ì—ì„œ í–…í‹±/ì§„ë™ í”¼ë“œë°±ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      } else if (supportsVibration) {
        vibrationStatus.textContent =
          "ì´ ê¸°ê¸°ëŠ” ì§„ë™ APIë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ì•„ë˜ íŒ¨í„´ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¦¬ë“¬ì„ ì´‰ê°ìœ¼ë¡œ ëŠê»´ë³´ì„¸ìš”.";
      } else {
        vibrationStatus.textContent =
          "ì´ ë¸Œë¼ìš°ì €/ê¸°ê¸°ëŠ” ì§„ë™ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }
    }

    document.querySelectorAll("button[data-vibrate]").forEach((btn) => {
      btn.addEventListener("click", () => {
        state.usedModules.vibration = true;
        updateBadgesAndStats();

        if (!supportsVibration) {
          alert(
            "ì´ í™˜ê²½ì—ì„œëŠ” ì›¹ ì§„ë™ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê¸°ê¸°/ë¸Œë¼ìš°ì € ì œí•œ)"
          );
          return;
        }
        const type = btn.getAttribute("data-vibrate");
        let pattern;
        switch (type) {
          case "rhythm":
            pattern = [0, 120, 60, 260, 80, 120];
            break;
          case "stress":
            pattern = [0, 80, 40, 240, 60, 80];
            break;
          case "combo":
          default:
            pattern = [0, 100, 40, 220, 50, 80, 40, 260];
            break;
        }
        navigator.vibrate(pattern);
        logEvent(`ì§„ë™ íŒ¨í„´ ì¬ìƒ: ${type}`);
      });
    });

    // ----------------------
    // ë¦½ë¦¬ë”© ëª¨ë“ˆ
    // ----------------------
    const mouthShapes = [
      { label: "ì•„", desc: "ì…ì„ í¬ê²Œ ë²Œë¦¬ê³  í„±ì„ ì¶©ë¶„íˆ ë‚´ë ¤ ì£¼ì„¸ìš”." },
      { label: "ì´", desc: "ì…ê¼¬ë¦¬ë¥¼ ì˜†ìœ¼ë¡œ ê¸¸ê²Œ ë²Œë¦¬ê³  ì¹˜ì•„ê°€ ì‚´ì§ ë³´ì´ë„ë¡ í•©ë‹ˆë‹¤." },
      { label: "ìš°", desc: "ì…ìˆ ì„ ì•ìœ¼ë¡œ ì‚´ì§ ë‚´ë°€ë©° ë™ê·¸ë—ê²Œ ëª¨ì•„ ì£¼ì„¸ìš”." },
      { label: "ë°”", desc: "ë‘ ì…ìˆ ì„ ê½‰ ë¶™ì˜€ë‹¤ê°€ ìˆœê°„ì ìœ¼ë¡œ ë–¼ë©´ì„œ ë°œìŒí•©ë‹ˆë‹¤." },
      { label: "ì‚¬", desc: "ìœ—ë‹ˆì™€ ì•„ë«ë‹ˆ ì‚¬ì´ë¡œ ê³µê¸°ê°€ ìƒˆì–´ë‚˜ê°€ë„ë¡ ë°œìŒí•©ë‹ˆë‹¤." }
    ];
    let mouthIndex = 0;

    const mouthShapeEl = document.getElementById("mouthShape");
    const mouthDescEl = document.getElementById("mouthDesc");

    function updateMouthUI() {
      const shape = mouthShapes[mouthIndex];
      if (mouthShapeEl) mouthShapeEl.textContent = shape.label;
      if (mouthDescEl) mouthDescEl.textContent = shape.desc;
    }

    document
      .getElementById("btnPrevMouth")
      .addEventListener("click", () => {
        state.usedModules.lipreading = true;
        updateBadgesAndStats();
        mouthIndex = (mouthIndex - 1 + mouthShapes.length) % mouthShapes.length;
        updateMouthUI();
      });

    document
      .getElementById("btnNextMouth")
      .addEventListener("click", () => {
        state.usedModules.lipreading = true;
        updateBadgesAndStats();
        mouthIndex = (mouthIndex + 1) % mouthShapes.length;
        updateMouthUI();
      });

    updateMouthUI();

    // ì¹´ë©”ë¼
    let lipCamStream = null;
    const lipCamera = document.getElementById("lipCamera");
    const lipCamStatus = document.getElementById("lipCamStatus");
    const btnStartLipCam = document.getElementById("btnStartLipCam");
    const btnStopLipCam = document.getElementById("btnStopLipCam");

    async function startLipCamera() {
      try {
        state.usedModules.lipreading = true;
        updateBadgesAndStats();

        lipCamStatus.textContent = "ì¹´ë©”ë¼ë¥¼ ì—¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
        btnStartLipCam.disabled = true;
        btnStopLipCam.disabled = false;

        lipCamStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        });
        lipCamera.srcObject = lipCamStream;
        lipCamStatus.textContent =
          "ì¹´ë©”ë¼ê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤. í™”ë©´ ì† ë‚´ ì…ëª¨ì–‘ì„ ìœ„ì˜ ì˜ˆì‹œì™€ ë¹„êµí•´ ë³´ì„¸ìš”.";
        logEvent("ë¦½ë¦¬ë”© ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.");
      } catch (e) {
        console.error(e);
        lipCamStatus.textContent =
          "ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €/OS ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.";
        btnStartLipCam.disabled = false;
        btnStopLipCam.disabled = true;
      }
    }

    function stopLipCamera() {
      if (lipCamStream) {
        lipCamStream.getTracks().forEach((t) => t.stop());
        lipCamStream = null;
      }
      lipCamera.srcObject = null;
      lipCamStatus.textContent = "ì¹´ë©”ë¼ê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤.";
      btnStartLipCam.disabled = false;
      btnStopLipCam.disabled = true;
      logEvent("ë¦½ë¦¬ë”© ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.");
    }

    btnStartLipCam.addEventListener("click", startLipCamera);
    btnStopLipCam.addEventListener("click", stopLipCamera);

    // ----------------------
    // í•™ìŠµì ëª¨ë“œ í† ê¸€ & ì²­ê°ì¥ì•  ì •ë„
    // ----------------------
    document.querySelectorAll(".mode-btn[data-mode]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const mode = btn.getAttribute("data-mode");
        state.learnerMode = mode;
        updateModeUI();
        saveState();
        logEvent(
          mode === "integrated"
            ? "í•™ìŠµì ëª¨ë“œ: í†µí•© ìˆ˜ì—…ìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤."
            : mode === "deaf"
            ? "í•™ìŠµì ëª¨ë“œ: ì²­ê°ì¥ì•  ì¤‘ì‹¬ìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤."
            : "í•™ìŠµì ëª¨ë“œ: ì¼ë°˜ í•™ìƒìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤."
        );
      });
    });

    document.querySelectorAll(".mode-btn[data-hearing]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const level = btn.getAttribute("data-hearing");
        state.hearingLevel = level;
        updateModeUI();
        saveState();
        if (state.learnerMode === "deaf") {
          const label =
            level === "mild"
              ? "ê²½ë„/ë¶€ë¶„ ë‚œì²­"
              : level === "moderate"
              ? "ì¤‘ë“±ë„"
              : "ê³ ë„Â·ë† ìˆ˜ì¤€";
          logEvent(`ì²­ê°ì¥ì•  ì •ë„ë¥¼ '${label}' í”„ë¡œí•„ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`);
        }
      });
    });

    // ----------------------
    // ì§„í–‰ë„ ì´ˆê¸°í™”
    // ----------------------
    document
      .getElementById("btnResetProgress")
      .addEventListener("click", () => {
        if (!confirm("ëª¨ë“  ì§„í–‰ë„ì™€ ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
        localStorage.removeItem(STORAGE_KEY);
        state.xp = 0;
        state.level = 1;
        state.attempts = 0;
        state.totalScore = 0;
        state.badges.consistency = false;
        state.badges.rhythmMaster = false;
        state.badges.allModules = false;
        state.usedModules.pronunciation = false;
        state.usedModules.vibration = false;
        state.usedModules.lipreading = false;
        state.history = [];
        state.learnerMode = "integrated";
        state.hearingLevel = "moderate";
        updateAllUI();
        logEvent("ì§„í–‰ë„ì™€ ê¸°ë¡ì„ ëª¨ë‘ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
      });

    // ----------------------
    // ì´ˆê¸° ê°€ë™
    // ----------------------
    window.addEventListener("load", () => {
      resizeCanvases();
      loadState();
      logEvent(
        "SoundStudy ë°ëª¨ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ìƒë‹¨ íƒ­ê³¼ í•™ìŠµì ëª¨ë“œë¥¼ ë°”ê¾¸ë©° í¬ìš©ì  ìˆ˜ì—… ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì²´í—˜í•´ ë³´ì„¸ìš”."
      );
    });
  </script>
</body>
</html>
